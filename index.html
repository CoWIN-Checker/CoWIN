<!DOCTYPE html>
<html lang="en">

<head>
    <title>Check CoWIN vaccine center(s) availability</title>
    <meta charset="utf-8" />
    <meta name="description" content="Quick way to check CoWIN vaccine center(s) availability.">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet"
        id="bootstrap-css" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
        integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css" />
    <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
</head>

<body>
    <div class="container">
        <br />
        <div class="page-header">
            <h2>Check CoWIN vaccine center(s) availability</h2>
        </div>
        <br />
        <form>
            <div class="form-row align-items-center">
                <div class="col-auto">
                    <input id="pincode" class="form-control mb-3" type="text" placeholder="Pincode" />
                </div>
                <div class="col-auto">
                    <div class="form-check form-check-inline">
                        <label class="form-check-label mb-3">Age</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input mb-3" type="radio" name="age" id="age18" value="18" checked />
                        <label class="form-check-label mb-3" for="age18">18+</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input mb-3" type="radio" name="age" id="age45" value="45" />
                        <label class="form-check-label mb-3" for="age45">45+</label>
                    </div>
                </div>
                <div class="col-auto">
                    <button id="btnCheckAvailability" class="btn btn-success mb-3" type="button">Check
                        availability</button>
                </div>
            </div>
        </form>
        <p>Only available center(s) will be displayed.</p>
        <div id="notAvailableMessage" class="alert alert-danger d-none" role="alert">
            Center not available!
        </div>
        <div id="tablediv" class="table-responsive d-none">
            <table id="table" class="table-striped border-success">
                <thead>
                    <tr>
                        <th data-field="centerName">
                            <span class="text-success"> Center Name </span>
                        </th>
                        <th data-field="date">
                            <span class="text-success"> Date </span>
                        </th>
                        <th data-field="availableCapacity">
                            <span class="text-success"> Available Capacity </span>
                        </th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</body>
<script>
    $("#table").bootstrapTable({
        data: [],
        autoRefresh: true,
    });
    document
        .getElementById("btnCheckAvailability")
        .addEventListener("click", function () {
            var pincode = document.getElementById("pincode").value;
            const date = moment(new Date()).format("DD-MM-YYYY");
            var url =
                "https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/calendarByPin?pincode=" +
                pincode +
                "&date=" +
                date;
            var availabilityData = [];

            $.ajax({
                method: "GET",
                url: url,
                contentType: "application/json",
                dataType: 'json',
                success: function (responseJson) {
                    if (responseJson.centers) {
                        var centers = responseJson["centers"];
                        var age = document.getElementById("age18").checked ? 18 : 45;
                        centers.forEach((center) => {
                            center.sessions.forEach((session) => {
                                if (
                                    session.available_capacity > 0 &&
                                    session.min_age_limit == age
                                ) {
                                    var availableSession = {
                                        centerName: center.name,
                                        date: session.date,
                                        availableCapacity: session.available_capacity,
                                    };
                                    availabilityData.push(availableSession);
                                }
                            });
                        });
                    }

                    if (availabilityData.length == 0) {
                        $("#notAvailableMessage").removeClass('d-none');
                        $("#tablediv").addClass('d-none');
                    } else {
                        $("#notAvailableMessage").addClass('d-none');
                        $("#tablediv").removeClass('d-none');
                    }
                    $('#table').bootstrapTable("load", availabilityData);
                },
                error: function (jqxhr, textStatus, error) {
                    if (jqxhr.status == 400) {
                        alert("Invalid pincode!");
                    } else {
                        alert("CoWIN server not available!");
                    }
                }
            })
        });

    $(document).ready(function () {
        var url = new URL(document.location);
        var params = url.searchParams;
        var pincode = params.get("pincode");
        if (pincode) {
            $("#pincode").val(pincode);
        }
        var age = params.get("age");
        if (age && age == 45) {
            document.getElementById("age45").checked = true;
        }
        var check = params.get("check");
        if (check) {
            $("#btnCheckAvailability").click();
        }

        $('#pincode').keypress(function (e) {
            var key = e.which;
            if (key == 13)  // the enter key code
            {
                $("#btnCheckAvailability").click();
                return false;
            }
        });
    });
</script>

</html>
